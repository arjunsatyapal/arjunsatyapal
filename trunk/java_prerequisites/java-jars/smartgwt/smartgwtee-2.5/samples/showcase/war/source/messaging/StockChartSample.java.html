<html>
<head>
<link rel='stylesheet' href='../../js/sh/SyntaxHighlighter.css' type='text/css' />
<script src='../../js/sh/shCore.js'></script>
<script src='../../js/sh/shBrushJava.js'></script>
<style>
* {
font-family:Courier New,monospace;
  padding: 0;
  margin: 0;
  white-space: nowrap;
  font-size: 11px;
}
.dp-highlighter {
  white-space: nowrap;
  overflow: visible;
  width: 600px;
  font-size: 11px;
  font-family:Courier New,monospace;
}
</style>
</head>
<body>
<textarea name='code' class='java:nogutter' rows='15' cols='120'>
/*
 * Isomorphic SmartGWT web presentation layer
 * Copyright (c) 2011 Isomorphic Software, Inc.
 *
 * OWNERSHIP NOTICE
 * Isomorphic Software owns and reserves all rights not expressly granted in this source code,
 * including all intellectual property rights to the structure, sequence, and format of this code
 * and to all designs, interfaces, algorithms, schema, protocols, and inventions expressed herein.
 *
 *  If you have any questions, please email <sourcecode@isomorphic.com>.
 *
 *  This entire comment must accompany any portion of Isomorphic Software source code that is
 *  copied or moved from this file.
 */

package com.smartgwt.sample.showcase.client.messaging;

import java.util.ArrayList;
import java.util.LinkedList;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.HashMap;

import com.smartgwt.client.types.ChartType;
import com.google.gwt.core.client.JavaScriptObject;
import com.google.gwt.i18n.client.NumberFormat;
import com.google.gwt.i18n.client.DateTimeFormat;
import com.google.gwt.user.client.Timer;
import com.smartgwt.client.data.DSCallback;
import com.smartgwt.client.data.DSRequest;
import com.smartgwt.client.data.DSResponse;
import com.smartgwt.client.data.Record;
import com.smartgwt.client.data.RecordList;
import com.smartgwt.client.rpc.Messaging;
import com.smartgwt.client.rpc.MessagingCallback;
import com.smartgwt.client.rpc.RPCManager;
import com.smartgwt.client.rpc.RPCRequest;
import com.smartgwt.client.types.DSOperationType;
import com.smartgwt.client.types.VerticalAlignment;
import com.smartgwt.client.util.JSOHelper;
import com.smartgwt.client.util.SC;
import com.smartgwt.client.widgets.Button;
import com.smartgwt.client.widgets.Canvas;
import com.smartgwt.client.widgets.HTMLFlow;
import com.smartgwt.client.widgets.Label;
import com.smartgwt.client.widgets.Window;
import com.smartgwt.client.widgets.chart.FacetChart;
import com.smartgwt.client.widgets.cube.Facet;
import com.smartgwt.client.widgets.events.ClickEvent;
import com.smartgwt.client.widgets.events.ClickHandler;
import com.smartgwt.client.widgets.grid.CellFormatter;
import com.smartgwt.client.widgets.grid.ListGrid;
import com.smartgwt.client.widgets.grid.ListGridRecord;
import com.smartgwt.client.widgets.layout.VLayout;

import com.smartgwt.sample.showcase.client.chart.SimpleChartData;

import com.google.gwt.core.client.EntryPoint;

public class StockChartSample implements EntryPoint {

    
    @Override
    
    RecordList initialData;
    RecordList lastValues;
    RecordList chartData;
    FacetChart chart;
    
    public void onModuleLoad() {
        Canvas topCanvas=null;
        if(SC.hasRealtimeMessaging() && SC.hasAnalytics()) {
            final long startParameter = System.currentTimeMillis();
            
            
            VLayout contentLayout = new VLayout();
            contentLayout.setMembersMargin(10);
            contentLayout.setPadding(10);
            
            final Button generateUpdatesButton = new Button("Generate more updates");
            generateUpdatesButton.setWidth(200);
            generateUpdatesButton.addClickHandler(new ClickHandler() {
                @Override
                public void onClick(ClickEvent event) {
                    generateUpdates(startParameter, generateUpdatesButton);
                }
            });
            contentLayout.addMember(generateUpdatesButton);
            
            chart = new FacetChart();
            chart.setFacets(new Facet("lastUpdated", "lastUpdated"), new Facet("name", "Name"));
            chart.setValueProperty("lastValue");
            chart.setChartType(ChartType.AREA);
            chart.setTitle("Portfolio Value");
            chart.setMinHeight(400);
            contentLayout.addMember(chart);
            
            // receive messages from the stockQuotes channel and update data grid
            Messaging.subscribe("stockQuotes" + startParameter, new MessagingCallback() {
                @Override
                public void execute(Object data) {
                    updateStockChart(data);
                }
            });
            
            StockQuotesDS.getInstance().fetchData(null, new DSCallback() {
            	public void execute(DSResponse response, Object data, DSRequest request) {
            		initialData = new RecordList(response.getData());
            		lastValues = new RecordList(initialData.duplicate());
            		chartData = new RecordList(initialData.duplicate());
                    String currentDate = dateFormatter.format(new Date());
            		for (int i=0; i<chartData.getLength(); i++) {
            			Record r = chartData.get(i);
            			r.setAttribute("lastUpdated", currentDate);
            		}
            	}
            });
    
            generateUpdates(startParameter, generateUpdatesButton);
            
            topCanvas = contentLayout;
        } else {
            HTMLFlow htmlFlow = new HTMLFlow("<div class='explorerCheckErrorMessage'><p>This example is disabled in this SDK because it requires the optional " +
            "<a href=\"http://www.smartclient.com/product/index.jsp\" target=\"_blank\">Real Time Messaging module</a>.</p>");
            htmlFlow.setWidth100();
            topCanvas = htmlFlow;
        }
        
        topCanvas.draw();
    }

    final DateTimeFormat dateFormatter = DateTimeFormat.getFormat("HH:mm:ss.S");
    @SuppressWarnings("unchecked")
    private void updateStockChart(Object data) {
        List<List<?>> stockData = (List<List<?>>) JSOHelper.convertToJava((JavaScriptObject) data);
        String currentDate = dateFormatter.format(new Date());
        RecordList newChartData =  new RecordList(chartData.duplicate());
        for (List<?> recordData : stockData) {
            float change = ((Number) recordData.get(1)).floatValue();
            Integer id = (Integer) recordData.get(0);
            Record record = initialData.find("id",id);
            String name = record.getAttributeAsString("name");
            int lastValueRecordIndex = lastValues.findIndex("name",name);
            Record lastValueRecord = lastValues.get(lastValueRecordIndex);
            float lastValue = lastValueRecord.getAttributeAsFloat("lastValue").floatValue();
            lastValue *= 1.0 + 20.0*0.01*change;
            Record newRecord = new Record();
            newRecord.setAttribute("lastValue", lastValue);
            newRecord.setAttribute("lastUpdated", currentDate);
            newRecord.setAttribute("name", name);
            lastValues.set(lastValueRecordIndex,newRecord);
        }
        newChartData.addList(lastValues.toArray());
        int recordsToRemove = newChartData.getLength() - 20*lastValues.getLength();
        if (recordsToRemove>0) {
        	newChartData.removeList(newChartData.getRange(0,recordsToRemove));
        }
        chart.setData(newChartData);
        chartData = newChartData;
    }

    private void generateUpdates(final long startParameter, final Button generateUpdatesButton) {
        generateUpdatesButton.disable();
        RPCRequest request = new RPCRequest();
        // we tells servlet which channel it should use for sending data
        request.setActionURL("examples/StockQuotes/generate?sp=" + startParameter);
        RPCManager.sendRequest(request);
        // block button repeat click for 90 seconds - time while servlet
        // will sends data to us
        new Timer() {
            public void run() {
                generateUpdatesButton.enable();
            }
        }.schedule(90000);
    }
    
    
}
</textarea>
<script class='javascript'>
dp.SyntaxHighlighter.HighlightAll("code");
</script>
</body>
</html>
